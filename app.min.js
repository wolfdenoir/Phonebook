function escapeURL(e){return String(e).replace(/[&<>\-'\/]/g,function(e){var r={"&":"%26","<":"%3C",">":"%3E","-":"\\-","'":"%60","\\":"%5C","[":"%5B","]":"%5D"};return r[e]})}function refreshPhonebook(){if($("article.phonebook").empty(),0!=arrStaff.length)for(var e=0;e<arrStaff.length;e++){if(null!=arrStaff[e].CellPhone&&""!=arrStaff[e].CellPhone){var r=$("<div/>",{html:"<div>"+arrStaff[e].Name+"</div><div>"+arrStaff[e].CellPhone+"</div>"});$("#cellphone article.phonebook").append(r)}if(null!=arrStaff[e].HomePhone&&""!=arrStaff[e].HomePhone){var a=$("<div/>",{html:"<div>"+arrStaff[e].Name+"</div><div>"+arrStaff[e].HomePhone+"</div>"});$("#homephone article.phonebook").append(a)}if(null!=arrStaff[e].WorkPhone&&""!=arrStaff[e].WorkPhone){var o=$("<div/>",{html:"<div>"+arrStaff[e].Name+"</div><div>"+arrStaff[e].WorkPhone+"</div>"});$("#workphone article.phonebook").append(o)}}}function enableFields(){$("#itin-main button, #itin-main input").removeClass("disabled"),$("#itin-splash button").removeClass("disabled")}function onQueryFailed(e,r){console.log("Request failed."+r.get_message()+"\n"+r.get_stackTrace())}function onQueryFailedJSON(e,r,a){null!=e.responseJSON?console.log(e.responseJSON.error.code+": "+e.responseJSON.error.message.value):console.log(e)}function getStaffPhones(){searchTerm='(JobTitle:"Support" JobTitle:"Servicing")',searchUrl=_spPageContextInfo.webAbsoluteUrl+"/_api/search/query?querytext='"+searchTerm+"'&sortlist='PreferredName:ascending'&selectproperties='PreferredName,AccountName,WorkPhone'&sourceid='"+_LOCAL_PEOPLE_RESULT_ID+"'&rowlimit='400'",console.log(searchUrl),$.ajax({url:searchUrl,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:onStaffPhoneJSON,error:onQueryFailedJSON})}function onStaffPhoneJSON(e){arrStaff=[];var r=e.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results,a=r.length;if(a>0){numReady=0;var o=$("#progress-phonelist");$("div.progress").hasClass("hidden")&&$("div.progress").removeClass("hidden"),$.each(r,function(e,r){var t={Name:r.Cells.results[2].Value,WorkPhone:null!=r.Cells.results[4].Value?r.Cells.results[4].Value:"",CellPhone:"",HomePhone:""};arrStaff.push(t);var n=_spPageContextInfo.webAbsoluteUrl+"/_api/sp.userprofiles.peoplemanager/getpropertiesfor(@v)?@v='"+String(r.Cells.results[3].Value).replace(/'/g,"''")+"'";$.ajax({url:n,type:"GET",headers:{Accept:"application/json; odata=verbose"},indexValue:e,total:a,progressbar:o,success:function(r){arrStaff[e].CellPhone=r.d.UserProfileProperties.results[48].Value,arrStaff[e].HomePhone=r.d.UserProfileProperties.results[50].Value,o.html("Getting phone numbers for "+numReady++ +" out of "+a+" Users."),o.attr("aria-valuenow",Math.ceil(numReady/a*100)+""),o.attr("style","width: "+Math.ceil(numReady/a*100)+"%"),arrStaff.length==numReady&&($("div.progress").hasClass("hidden")||$("div.progress").addClass("hidden"),refreshPhonebook())},error:onQueryFailedJSON})}),console.log("arrStaff: "+arrStaff.length)}else $("article.phonebook").html("Can't find any staff in the directory.")}var _LOCAL_PEOPLE_RESULT_ID="B09A7990-05EA-4AF9-81EF-EDFAB16C4E31",arrStaff=[],prop,context=new SP.ClientContext.get_current,web=context.get_web(),user=web.get_currentUser();$(document).ready(function(){$(window).resize(function(){}),context.load(user),context.executeQueryAsync(function(){console.log(user),getStaffPhones()},function(){alert("Connection Failed. Refresh the page and try again. :(")})});