function refreshPhonebook(){if($("article.phonebook").empty(),0!=arrStaff.length)for(var e=0;e<arrStaff.length;e++){if(""!=arrStaff[e].CellPhone){var r=$("<div/>",{html:"<p>"+arrStaff[e].Name+"</p><p>"+arrStaff[e].CellPhone+"</p>"});$("#cellphone article.phonebook").append(r)}if(""!=arrStaff[e].HomePhone){var o=$("<div/>",{html:"<p>"+arrStaff[e].Name+"</p><p>"+arrStaff[e].HomePhone+"</p>"});$("#homephone article.phonebook").append(o)}if(""!=arrStaff[e].WorkPhone){var a=$("<div/>",{html:"<p>"+arrStaff[e].Name+"</p><p>"+arrStaff[e].WorkPhone+"</p>"});$("#workphone article.phonebook").append(a)}}}function getStaffPhones(){searchTerm='(JobTitle:"Support" JobTitle:"Servicing" JobTitle:"Coordinator" JobTitle:"Director" JobTitle:"Executive" JobTitle:"President" JobTitle:"Treasurer")',searchUrl=_spPageContextInfo.webAbsoluteUrl+"/_api/search/query?querytext='"+searchTerm+"'&sortlist='PreferredName:ascending'&selectproperties='PreferredName,AccountName,WorkPhone'&sourceid='"+_LOCAL_PEOPLE_RESULT_ID+"'&rowlimit='400'",console.log(searchUrl),$.ajax({url:searchUrl,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:onStaffPhoneJSON,error:onQueryFailedJSON})}function onStaffPhoneJSON(e){arrStaff=[];var r=e.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results,o=r.length;if(o>0){numReady=0;var a=$("#progress-phonelist");$("div.progress").hasClass("hidden")&&$("div.progress").removeClass("hidden"),$.each(r,function(e,r){var t={Name:r.Cells.results[2].Value,WorkPhone:null!=r.Cells.results[4].Value?r.Cells.results[4].Value:"",CellPhone:"",HomePhone:""};arrStaff.push(t);var s=_spPageContextInfo.webAbsoluteUrl+"/_api/sp.userprofiles.peoplemanager/getpropertiesfor(@v)?@v='"+String(r.Cells.results[3].Value).replace(/'/g,"''")+"'";$.ajax({url:s,type:"GET",headers:{Accept:"application/json; odata=verbose"},indexValue:e,total:o,progressbar:a,success:function(r){"undefined"!=typeof r.d.UserProfileProperties?(arrStaff[e].CellPhone=null!=r.d.UserProfileProperties.results[48].Value?r.d.UserProfileProperties.results[48].Value:"",arrStaff[e].HomePhone=null!=r.d.UserProfileProperties.results[50].Value?r.d.UserProfileProperties.results[50].Value:""):console.log(arrStaff[e].Name+"'s profile is missing."),a.html("Getting phone numbers for "+numReady++ +" out of "+o+" Users."),a.attr("aria-valuenow",Math.ceil(numReady/o*100)+""),a.attr("style","width: "+Math.ceil(numReady/o*100)+"%"),arrStaff.length==numReady&&($("div.progress").hasClass("hidden")||$("div.progress").addClass("hidden"),refreshPhonebook())},error:onQueryFailedJSON})})}else $("article.phonebook").html("Can't find any staff in the directory.")}function onQueryFailedJSON(e,r,o){null!=e.responseJSON?console.log(e.responseJSON.error.code+": "+e.responseJSON.error.message.value):console.log(e)}var _LOCAL_PEOPLE_RESULT_ID="B09A7990-05EA-4AF9-81EF-EDFAB16C4E31",arrStaff=[],context=new SP.ClientContext.get_current,web=context.get_web(),user=web.get_currentUser();$(document).ready(function(){context.load(user),context.executeQueryAsync(function(){console.log(user),getStaffPhones()},function(){alert("Connection Failed. Refresh the page and try again. :(")})});